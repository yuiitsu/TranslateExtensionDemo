"use strict";var App={module:{extend:function(e,n){n.prototype=App,this[e]=new n},call:function(e,n,t){if(!this.hasOwnProperty(e))return App.log("Error: "+e+" not existed"),!1;if(!this[e].hasOwnProperty(n))return App.log("Error: "+n+" not existed in "+e),!1;try{this[e][n](t)}catch(e){App.log(e)}},run:function(){for(var e in this)this.hasOwnProperty(e)&&this[e].hasOwnProperty("init")&&(this[e].init(),App.log("[Module] "+e+" init."))}},event:{extend:function(e,n){n.prototype=App,this[e]=new n},init:function(){for(var e in this)this.hasOwnProperty(e)&&this[e].hasOwnProperty("event")&&(this.listen(this[e]),App.log("[Event] "+e+" is listening."))},listen:function(e){for(var n in e.event)e.event.hasOwnProperty(n)&&e.event[n]()},addListener:function(e){}},view:{display:function(e,n,t,o){this.eval_view_func(e,n),(o?$(o):$("body")).html(this[e+"."+n].init(t))},append:function(e,n,t,o){this.eval_view_func(e,n),(o?$(o):$("body")).append(this[e+"."+n].init(t))},getView:function(e,n,t){return this.eval_view_func(e,n),this[e+"."+n].init(t)},extend:function(e,n){n.prototype=App,this[e]=new n},eval_view_func:function(e,n){var t=e+"."+n;if(!this.hasOwnProperty(t)){var o=this[e][n](),i=[],r=["App.view.extend('"+e+"."+n+"', function() {"];for(var s in r.push("this.init = function(data) {"),r.push("var html = '';"),o=o.split("\n"))i.push(this.parse(o[s]));r.push(i.join("")),r.push("return html;"),r.push("}"),r.push("});"),new Function("return function v() {"+r.join("")+"}")()()}},parse:function(e){if(!e||""===e)return null;var t=e.trim().replace(new RegExp(/'/g),"\\'"),o=!1;return function(){for(var e=void 0,n=/\{\{ for (.+?) \}\}/i;e=n.exec(t);)o=!0,t=t.replace(e[0],"for("+e[1].replace(new RegExp(/\\/g),"")+"){")}(),function(){for(var e=void 0,n=/\{\{ if (.+?) \}\}/i;e=n.exec(t);)o=!0,t=t.replace(e[0],"if("+e[1].replace(new RegExp(/\\/g),"")+"){");for(n=/\{\{ else if (.+?) \}\}/i;e=n.exec(t);)o=!0,t=t.replace(e[0],"} else if("+e[1].replace(new RegExp(/\\/g),"")+"){");for(n=/\{\{ else \}\}/i;e=n.exec(t);)o=!0,t=t.replace(e[0],"} else {")}(),function(){for(var e=void 0,n=/\{\{ end \}\}/i;e=n.exec(t);)o=!0,t=t.replace(e[0],"}")}(),function(){for(var e=void 0,n=/\{\{ var (.+?) \}\}/i;e=n.exec(t);)o=!0,t=t.replace(e[0],"var "+e[1].replace(new RegExp(/\\/g),"")+";")}(),function(){for(var e=void 0,n=/\{\{ (.+?) \}\}/i;e=n.exec(t);)t=t.replace(e[0],"'+"+e[1].replace(new RegExp(/\\/g),"")+"+'")}(),o||(t="html += '"+t+"';"),t}},browser:{onMessage:function(){var e=this.getBrowser();if(!this.environment.hasOwnProperty(e))return App.log("not found browser api: "+e),!1;this.environment[e].onMessage()},sendMessage:function(e){var n=this.getBrowser();if(!this.environment.hasOwnProperty(n))return App.log("not found browser api: "+n),!1;this.environment[n].sendMessage(e)},environment:{chrome:{onMessage:function(){chrome.runtime.onMessage.addListener(function(e,n,t){var o=e.module,i=e.method,r=e.data;App.module.hasOwnProperty(o)&&App.module[o].hasOwnProperty(i)?App.module[o][i](r,t):App.log("module: "+o+", method: "+i+" not exist."),t({})})},sendMessage:function(e){chrome.runtime.sendMessage(e,function(e){console.log(e)})},sendMessageTabs:function(e,n){chrome.tabs.sendMessage(tab_id,{module:e,method:n},function(e){})}},firefox:{onMessage:function(){browser.runtime.onMessage.addListener(function(e,n,t){var o=e.module,i=e.method,r=e.data;App.module.hasOwnProperty(o)&&App.module[o].hasOwnProperty(i)?App.module[o][i](r,t):App.log("module: "+o+", method: "+i+" not exist."),t({})})},sendMessage:function(e){console.log(e),browser.runtime.sendMessage(e).then(function(e){},function(e){})},sendMessageTabs:function(e,n){browser.tabs.sendMessage(tab_id,{module:e,method:n},function(e){})}}},getBrowser:function(){var e=window.navigator.userAgent,n="";return e.match(/Chrome\//)?n="chrome":e.match(/Firefox\//)&&(n="firefox"),n}},log:function(e){console.log("[CES]",e)},run:function(){this.module.run(),this.event.init()}};$(function(){App.run()});